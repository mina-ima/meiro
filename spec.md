# MEIRO（オーナー/プレイヤー非対称）要件定義 v0.1

---

## 0. 目的 / 概要
- 同一迷路を舞台に、**オーナー**（俯瞰編集役）と**プレイヤー**（一人称探索役）が非対称に対戦するリアルタイムゲーム（PCブラウザ向け）。
- プレイヤーはポイント玉を回収し規定ポイント到達を目指す。オーナーは壁追加/削除・罠設置でそれを妨害する。
- v1は**1対1**専用、観戦モードは**未実装**（将来拡張）。

---

## 1. ターゲット / プラットフォーム
- 初期リリース: **PCブラウザ限定**（スマホは非対応）
- フレームワーク: **React + Phaser（2D Canvas）**
- 一人称表現: **レイキャスト風**（Phaser上で自前実装）
- クライアント描画上限: **30fps**

---

## 2. サーバ / インフラ
- アーキテクチャ: **サーバー権威型**（判定はサーバで最終確定）
- 通信: **Cloudflare Workers + Durable Objects（DO）** によるWebSocket常時接続
  - 1ルーム=1 DO で接続・状態を強整合管理
- 静的ホスティング: **Cloudflare Pages**
- サーバTick: **20Hz**

---

## 3. アカウント / マッチング
- ログイン: **不要**（ニックネームのみ）
  - 文字種: **英数字 + '-' + '_'** のみ
  - 文字数: **2〜10** 文字
  - NGワード検出: **なし**
- ルーム作成: オーナーが部屋を作成 → **6桁 英大文字+数字（O/I/1/0除外）** のコード発行
- 参加: プレイヤーはコード入力で入室
- 待機タイムアウト: **5分**で自動解散
- 再戦: **同じ部屋でワンクリック再戦**可。役割は**毎回50/50ルーレット**で決定
- 乱数シード: **毎ラウンド新規生成（再戦でも新迷路）**

---

## 4. ゲームフロー / 状態遷移
1. **ロビー**（オーナーが部屋作成、プレイヤー入室を待つ）
2. **共通カウントダウン**（3,2,1…）
3. **準備フェーズ**（合計60秒、早期開始不可）
   - (a) **ポイント配置**: 40秒
   - (b) **罠配置**: 5秒
   - (c) **予測地点マーキング**: 15秒
   - ※終了10秒前から両画面端に残秒カウント表示
4. **探索フェーズ**（制限時間: オーナーが事前設定、デフォルト5分/上限10分）
5. **終了/判定 → リザルト**（WIN/LOSEと各指標表示）

> **リロール**: 迷路の再生成は**準備開始前のみ**許可（ロビー〜共通カウント前）。

---

## 5. 迷路仕様
- サイズ: **20×20** / **40×40**（デフォルト**40×40**）
- 生成アルゴリズム: **棒倒し法 / 穴掘り法** 系のシンプル法
- **最短ルート長の下限**: 一辺Lに対し **K=4** → 最短歩数 ≥ 4×L
  - 20×20→≥80歩、40×40→≥160歩
- スタート/ゴール: **ランダム各1箇所**（互いに十分離す）。ゴールは**常に1つ**。
- 表現: 上から見た方眼（通路/壁）。**壁はセルの「辺」**に沿って存在。

---

## 6. 役割別ビューとUI
### 6.1 プレイヤー（一人称）
- 表現: **レイキャスト風**一人称。**ヘッドボブなし**。
- FOV: **90°**
- 「ライト」視界: 前方コーンの**到達距離4マス**（**4マス目は減光**）。壁で遮断。
- HUD（常時）:
  - 残り時間
  - 現在ポイント
  - **ゴール到達ボーナス値**（= 規定ポイントの20%）
- ミニマップ: **表示しない**
- 準備中表示: **ランダム通路プレビュー動画**（5秒クリップが次々自動再生）
  - 迷路の様々な地点・向きからの視点
  - **毎回必ず1回**、ゴールが映るクリップを含める

### 6.2 オーナー（俯瞰）
- 表現: **上から見下ろし**の全体マップ
- 操作ビュー: **ズーム＆パン**対応
  - 初期倍率: 画面内**全体が入る倍率の2倍**
  - 最小倍率: **全体表示**
  - 最大倍率: 画面内に**3×3=9マス**だけが見える倍率
- HUD（常時）:
  - 残り時間（準備/探索）
  - プレイヤー現在位置
  - 壁 **残り本数**（消費/返却/予測ボーナス反映）
  - 壁削除権利 **残: 0/1**
  - 罠設置権利 **残数**（初期1、予測ボーナス反映） / **現在設置数(0〜2)**
  - 連打クールダウン表示（次操作までX.X秒）
  - 禁止エリアの薄表示（ホバー時に強調）
  - 規定ポイント（合計配置の**65%切上げ**）とプレイヤー現在ポイント

---

## 7. 操作仕様
### 7.1 プレイヤー操作（PC）
- **W**: 前進 / **S**: 後退 / **A**: 左回転 / **D**: 右回転
- ストレイフ（横移動）: **なし**
- 回転速度: **360°/秒**
- 前進速度: **1マス=0.5秒**（= **2.0 マス/秒**）
- 当たり判定: **半径0.35マス**の円
- 角衝突時: **スライド補正**（壁に沿って滑らせる）

### 7.2 オーナー操作
- ツール切替（ショートカット）:
  - **1**: 壁追加モード
  - **2**: 壁削除モード（※**権利は1回のみ**）
  - **3**: 罠設置モード
  - **Esc**: キャンセル
- 予測地点マーキング: **準備フェーズ(15秒)**のみ、マウス**左クリックでトグル**（最大**3箇所**）
- 配置/削除の確定方式（共通）:
  - 対象上でクリック → **カーソル付近ポップ**で確認表示 → **同じ場所を再クリックで確定**
  - **Esc / 右クリックでキャンセル**
- 連続編集制限: **1.0秒クールダウン / 確定1回**

---

## 8. ルール / 制約
### 8.1 壁（線）
- 単位: **「1本=方眼の1目盛（セルの辺）」**
- 初期本数（スタンダード）:
  - **20×20: 48本**
  - **40×40: 140本**
- 追加/削除:
  - **追加**= 1本消費
  - **削除**= **1回だけ**使用可能な「壁削除権利」で、選択線を削除 → **本数枠が返却**
- 予測通過ボーナス: 通過1回ごとに**+1本**付与 **または**「罠設置権利+1」を**ランダム**付与（**線70% / 罠30%**）
- 編集禁止エリア:
  - **プレイヤー周囲: マンハッタン距離2以内**（壁追加/削除とも不可）
- **経路保証**: いかなる編集でも**プレイヤー→ゴールの到達可能経路を1本以上**維持。違反編集は**即無効**

### 8.2 罠（減速）
- 設置位置: **通路マスの中心**（壁上には置けない）
- 効果: プレイヤー移動速度が**40%**に低下
- 持続: **制限時間の1/5**（例: 5分なら60秒）
- 連続ヒット: **延長**（残り時間に加算）
- 使用回数/同時数:
  - **初期権利=1**
  - **同時設置上限=2個**
  - **単発型**: 踏まれた罠は**消滅**（撤去しても権利は戻らない）
- 配置タイミング: **準備フェーズ**と**探索フェーズ中**の両方で可能
- 禁止エリア: **スタート半径2 / ゴール半径3**（マス単位）
- 重ね置き: **ポイント玉との重なり不可**
- 可視性:
  - **プレイヤー: 見えない**（隠し罠）
  - **オーナー: 常時見える**

### 8.3 予測地点
- 設定数: **3箇所**（準備フェーズの最後の15秒で設定）
- 通過効果:
  - **オーナー**: ランダム報酬（**線+1** 70% / **罠権利+1** 30%）
  - **プレイヤー**: **「予測地点を通過！」**の通知のみ（付与内容は非公開）

### 8.4 ポイント玉
- 種類: **1点 / 3点 / 5点** の3種類
- オーナーの配置制約（初期）:
  - **20×20**: **合計ポイント下限=40点**、**配置数上限=12個**
  - **40×40**: **合計ポイント下限=60点**、**配置数上限=18個**
  - ※上限YはUIで超過不可。下限Xに**未達**の場合 → **不足分をプレイヤーの初期ポイントとして付与**（ただし**規定ポイント−1**を上限にクリップ）
- 配置タイミング: **準備フェーズ(40秒)のみ**
- 重ね置き: **罠と重ね不可**（玉同士の同位置は不可）

---

## 9. 勝敗 / スコア
- **規定ポイント**: その回の**合計配置ポイントの65%**（**切上げ**）
- **終了条件**: プレイヤーが**規定ポイント以上を獲得した時点**で即終了
- **ゴールボーナス**: 到達時に**規定ポイントの1/5**を加算（**残り時間は加点なし**）
  - ゴール時に**規定未達**ならゲームは続行
- **勝敗**:
  - 規定到達 → **プレイヤーWIN**
  - 制限時間切れまでに規定未達 → **オーナーWIN**
- リザルト（両者）:
  - **WIN/LOSE**
  - 残り時間（切れた場合は0）
  - 最終ポイント
  - 停止画面（プレイヤー=一人称停止、オーナー=俯瞰停止）

---

## 10. 準備フェーズ詳細（60秒）
1) **ポイント配置（40秒）**
   - UIに現在の **合計ポイント/下限X** と **個数/上限Y** を表示
   - 未達のまま時間終了 → 不足分を**プレイヤー初期ポイント**に付与（上限=規定−1）
2) **罠配置（5秒）**
   - 初期権利=1、同時上限2、禁止エリア/重ね不可チェック
3) **予測地点（15秒）**
   - 最大3箇所をクリックで設定

> 準備中、プレイヤー画面は**5秒クリップの通路プレビュー**が連続再生（**ゴールが必ず1回映る**）

---

## 11. 編集UI / バリデーション
- 確認UI: **カーソル付近ポップオーバー**（「設置しますか？」→**同じ場所を再クリック**で確定）
- エラーハンドリング:
  - 禁止エリア、資源不足、重ね不可、経路封鎖 → **不成立**（赤アウトライン & トースト）
- ハイライト:
  - 禁止エリア: 通常は**薄く**表示、**ホバー時に強調**

---

## 12. 効果音 / 演出
- 効果音のみ（BGMなし）
  - ポイント取得: 「ポン」系短音 + 発光エフェクト
  - 予測地点通過: 軽い通知音 + 画面テキスト
  - 勝敗決定: 短いジングル
- 音量: **初期70%**、ミュート切替あり
- 壁/罠の視界内反映: **無演出の即時切替**（A）

---

## 13. 通信切断時の扱い
- いずれか切断 → **即時ポーズ**
- 猶予: **60秒**
- 60秒で復帰なし:
  - **プレイヤー不在** → オーナー勝利
  - **オーナー不在** → プレイヤー勝利
  - **双方不在** → **ノーゲーム**

---

## 14. データモデル（サーバ）
- **Room**: { roomId, status, seed, size, createdAt, owner, player, spectators(なし), timeoutAt }
- **Maze**: { sizeL, cells[L][L], walls(set of edges), start(x,y), goal(x,y) }
  - edge: { (x,y,dir) } dir∈{N,E,S,W}
- **OwnerState**: { wallStock, wallRemoveLeft(0/1), trapRights, traps[], predictSites[], cdUntil }
- **PlayerState**: { pos(x,y,angle), vx, vy, slowedUntil, score, previewSeed }
- **Rules**: { pointLowerBound, pointCountUpper, requiredRate(0.65), goalBonusRate(0.2), trapSlowRate(0.4), trapDur=limit/5 }
- **Points**: [{x,y,value}]（value∈{1,3,5}）

---

## 15. サーバ判定（例）
- 位置更新: 20Hzで速度/回転を積分、壁衝突はAABB→スライド補正
- 罠発動: プレイヤー中心が罠セルに侵入したTickで発火→slow付与→罠削除
- 壁編集: 事前チェック（資源・禁止エリア・重なり・経路保証BFS）→確定→全クライアントにブロードキャスト
- 規定ポイント: `ceil(0.65 * totalPlacedPoints)`
- 終了判定: `player.score >= required` で即勝利

---

## 16. セキュリティ / 公平性
- サーバー権威型で**位置/衝突/罠/編集**を全て検証
- クライアントは**補間表示のみ**。改ざんを無視
- レート制限: オーナー操作は**1.0秒CD**

---

## 17. ログ / 保存
- v1は**リザルト保存なし**（履歴・統計・リプレイ未実装）

---

## 18. 国際化
- UIテキストはリソース分離。**日本語のみ実装**、将来多言語化前提

---

## 19. 非機能要件（抜粋）
- 起動〜ロビー表示: 3秒以内（初回キャッシュ後）
- 体感遅延: 100ms以下（サーバ20Hz/30fps前提）
- ブラウザ互換: 最新Chrome/Edge/Firefox（WebGL/Canvas有効）

---

## 20. 変更履歴（要点）
- 角抜け: 8方向→レイキャスト移行に伴い**スライド補正**方針で集約
- ゴール時挙動: **ゴール即終了**→**規定到達で終了**に変更（ゴールはボーナス付与のみ）
- 壁資源: 「本数×長さ」→ **1目盛=1本**の合計本数管理に変更
- プレイヤー編集禁止半径: **マンハッタン2** に確定（旧:3）

---

## 21. 未決/今後の検討
- スコア統計/履歴保存、観戦モード、チュートリアル
- 操作チューニング（回転/移動の個別スライダー）
- テーマスキン（床/壁テクスチャ差し替え）

